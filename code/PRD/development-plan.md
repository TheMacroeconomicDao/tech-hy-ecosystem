# Экосистема TECH HY: Обзор

Экосистема TECH HY — это децентрализованная финансовая система на Solana, построенная на двух токенах (VC и VG) и наборе смарт-контрактов, обеспечивающих их взаимодействие, стейкинг, управление и получение дохода.

**Ключевые Компоненты и Логика:**

1.  **Токены:**
    *   **VC Token (Venture Card Token):**
        *   **Тип:** Стандартный SPL-токен.
        *   **Эмиссия:** 5 миллиардов, полностью созданы при инициализации. Дальнейший минт невозможен. Freeze authority отсутствует.
        *   **Назначение:** Утилитарный токен. Используется для:
            *   Формирования LP-токенов (в паре с SOL) в механизме "Burn and Earn".
            *   Стейкинга для получения NFT-бустеров "Investor's Hand".
            *   Оплаты услуг в экосистеме.
    *   **VG Token (Venture Gift Token):**
        *   **Тип:** Токен стандарта Token-2022 с расширением **Transfer Hook**.
        *   **Эмиссия:** 1 миллиард, полностью созданы при инициализации программы `vg-token` и размещены на специальном эскроу-счете, контролируемом программой "Burn and Earn". Дальнейший минт невозможен. Freeze authority отсутствует.
        *   **Назначение:** Токен управления (governance) и для стейкинга.
        *   **Налог на транзакции (по умолчанию 10%, управляемый DAO):** Реализован через **Transfer Hook**. При каждом переводе VG токенов автоматически вызывается отдельная программа-хук, которая:
            1.  Загружает `TaxConfig` из программы `vg-token` для получения актуальной ставки налога и адресов назначения.
            2.  Проверяет, является ли отправитель (`source_token_account.owner`) адресом эскроу-счета программы "Burn and Earn" (адрес которого также хранится в `TaxConfig`). Если да, налог не взимается.
            3.  В противном случае, рассчитывает налог согласно текущей ставке из `TaxConfig`.
            4.  Списывает сумму налога с токен-счета отправителя.
            5.  Распределяет этот налог в соответствии с долями, указанными в `TaxConfig`:
                *   Часть (например, 50%) перечисляется на токен-аккаунт **казны DAO** (адрес из `TaxConfig`).
                *   Часть (например, 50%) перечисляется на специальный токен-аккаунт **`NFTHoldersTaxPoolAcc`**. Владельцем (authority) этого `NFTHoldersTaxPoolAcc` является PDA, принадлежащий **программе `nft_fee_key_program`** (адрес этого пула также берется из `TaxConfig`).

2.  **Основные Механизмы и Смарт-Контракты:**

    *   **А. Программа `vc-token`:**
        *   Отвечает за инициализацию VC токена, его полную эмиссию на начальный распределительный счет (например, казначейство TECH-HY или DAO) и отзыв mint/freeze authority.
        *   Может содержать административные функции для DAO по обновлению метаданных VC (если это будет сочтено необходимым).

    *   **Б. Программа `vg-token` (основная, для минта и конфигураций):**
        *   Отвечает за инициализацию VG минта (Token-2022) и установку на него **Transfer Hook**, указывая ID отдельной программы-хука (`vg_transfer_hook_program`).
        *   Производит полную начальную эмиссию 1 млрд VG на эскроу-счет, контролируемый программой "Burn and Earn".
        *   Отзывает `mint_authority` у VG минта.
        *   Управляет PDA `TaxConfig`. Инструкция `upsert_tax_config` позволяет авторитету DAO (инициатор при первом вызове, затем только текущий `tax_config.authority`) устанавливать и обновлять:
            *   `tax_rate_bps`: Текущая ставка налога в базисных пунктах.
            *   `dao_share_bps`: Доля налога для казны DAO.
            *   `nft_holders_share_bps`: Доля налога для пула NFT Fee Key.
            *   `dao_treasury_token_account_pubkey`: Адрес токен-аккаунта казны DAO.
            *   `nft_pool_token_account_pubkey`: Адрес токен-аккаунта `NFTHoldersTaxPoolAcc`.
            *   `burn_and_earn_escrow_pda_pubkey`: Pubkey PDA эскроу-счета программы "Burn and Earn", переводы с которого освобождаются от налога.
        *   Управляет метаданными VG токена (с возможностью обновления через DAO).
        *   **Примечание:** Программа `vg-token` **не управляет** напрямую клеймом наград для NFT Fee Key или хранением `NFTHolderInfo`. Эта ответственность полностью лежит на программе `nft_fee_key_program`.

    *   **В. Программа-хук для VG Token (`vg_transfer_hook_program`) - ОТДЕЛЬНЫЙ КОНТРАКТ:**
        *   **Единственная ответственность:** Обработка логики налога при каждом переводе VG токенов.
        *   **Логика:**
            1.  Вызывается автоматически программой Token-2022 при стандартном переводе VG.
            2.  Получает информацию о трансфере и необходимые аккаунты (включая PDA `TaxConfig` из программы `vg-token`, токен-аккаунт казны DAO, токен-аккаунт `NFTHoldersTaxPoolAcc`) через механизм `extra_account_metas`.
            3.  Загружает актуальные параметры из `TaxConfig`.
            4.  Проверяет, является ли отправитель (`source_token_account.owner`) адресом `burn_and_earn_escrow_pda_pubkey` из `TaxConfig`. Если да, завершает работу без взимания налога.
            5.  В противном случае, рассчитывает налог на основе `tax_rate_bps`.
            6.  Выполняет CPI-переводы рассчитанной суммы налога (списанной с токен-счета отправителя, используя полномочия инициатора транзафера) на счета, указанные в `TaxConfig`: `dao_treasury_token_account_pubkey` и `nft_pool_token_account_pubkey`, согласно долям `dao_share_bps` и `nft_holders_share_bps`.
        *   **Важно:** Программа-хук должна быть тщательно спроектирована для корректной работы с полномочиями и `extra_account_metas` и быть максимально легковесной и безопасной.

    *   **Г. Программа "Burn and Earn" (`burn_and_earn_program`):**
        *   **Вход:** Пользователь предоставляет VC токены и SOL.
        *   **Действия:**
            1.  Интегрируется с Raydium для создания LP-токенов VC/SOL.
            2.  Перманентно блокирует эти LP-токены в своем хранилище (PDA).
            3.  Рассчитывает количество VG токенов, которое должен получить пользователь (по формуле `VG = LP * C * (1 + B * log10(LP/LP_min))`).
            4.  Инициирует **перевод** (не минт!) рассчитанного количества VG токенов со своего PDA-контролируемого эскроу-счета на токен-аккаунт пользователя. Этот перевод идентифицируется программой-хуком (через `TaxConfig`) и **не облагается налогом**.
            5.  Вызывает программу `nft_fee_key_program` (инструкцию `CreateNftFeeKeyAndInfo`), передавая `owner` (адрес пользователя), `locked_lp_amount` и рассчитанный `tier_multiplier` для создания NFT Fee Key.

    *   **Д. Программа "NFT Fee Key" (`nft_fee_key_program`):**
        *   **Ответственность:** Полное управление жизненным циклом NFT Fee Key, включая их создание, хранение связанной информации о долях и обработку клейма вознаграждений держателями из управляемого ею пула налогов.
        *   **Ключевая логика и компоненты:**
            1.  **Создание NFT Fee Key:**
                *   Вызывается программой "Burn and Earn" (инструкция `CreateNftFeeKeyAndInfo`).
                *   Минтит (через Metaplex) NFT Fee Key, уровень и `tier_multiplier` которого определяются на основе `locked_lp_amount` (переданного из "Burn and Earn").
                *   Создает и сохраняет PDA `NFTHolderInfo` для каждого нового NFT Fee Key.
                *   Обновляет (увеличивает) глобальное значение `total_weighted_locked_lp`.
            2.  **Хранилище Информации (`NFTHolderInfo` - PDA):**
                *   Для каждого NFT Fee Key создается PDA `NFTHolderInfo { nft_mint (ключ), owner, locked_lp_amount, tier_multiplier, last_claimed_timestamp }`.
            3.  **Учет Общей Базы для Долей (Глобальный PDA Программы):**
                *   Программа хранит и обновляет значение `total_weighted_locked_lp` в своем конфигурационном PDA. Это общая сумма всех `locked_lp_amount * tier_multiplier` по всем активным NFT Fee Key. Увеличивается при создании нового NFT Fee Key.
            4.  **Пул Накопленных Налогов (`NFTHoldersTaxPoolAcc`):**
                *   Это токен-аккаунт (для VG токенов), на который программа-хук VG токена перечисляет долю налогов, предназначенную для держателей NFT Fee Key.
                *   **Владельцем (authority) этого `NFTHoldersTaxPoolAcc` является PDA, принадлежащий этой программе (`nft_fee_key_program`)**.
            5.  **Инструкция `claim_reward`:**
                *   **Вызов:** Держатель NFT Fee Key вызывает эту инструкцию, предоставляя `mint` своего NFT.
                *   **Действия программы:**
                    a.  Загружает `NFTHolderInfo` для предоставленного `nft_fee_key_mint` и глобальный `total_weighted_locked_lp`.
                    b.  Проверяет, что вызывающий является текущим `owner` из `NFTHolderInfo`.
                    c.  Рассчитывает долю данного NFT в общем пуле: `user_share_basis_points = (NFTHolderInfo.locked_lp_amount * NFTHolderInfo.tier_multiplier * 10000) / total_weighted_locked_lp`.
                    d.  Определяет текущий доступный баланс в `NFTHoldersTaxPoolAcc`.
                    e.  Рассчитывает сумму VG токенов к выплате: `claimable_amount = (current_pool_balance_of_NFTHoldersTaxPoolAcc * user_share_basis_points) / 10000`. (Примечание: этот метод предполагает клейм доли от текущего общего пула. Он прост для старта, но может быть не идеально справедлив при нерегулярных клеймах и значительных колебаниях баланса пула. Более сложные накопительные механики могут быть рассмотрены в будущем.)
                    f.  **Используя свои PDA-полномочия (как authority для `NFTHoldersTaxPoolAcc`), программа переводит** `claimable_amount` с `NFTHoldersTaxPoolAcc` на токен-аккаунт пользователя (владельца NFT).
                    g.  Обновляет `last_claimed_timestamp` в `NFTHolderInfo`.
        *   **API / Инструкции (пример):**
            *   `InitializeNftFeeKeyProgram { params }`
            *   `CreateNftFeeKeyAndInfo { owner: Pubkey, locked_lp_amount: u64, tier_multiplier: u16 }`
            *   `ClaimReward { nft_fee_key_mint: Pubkey }`

    *   **Е. Программа Стейкинга VC (`vc_staking_program`) и NFT "Investor's Hand":**
        *   **Ответственность:** Стейкинг VC токенов и управление NFT-бустерами "Investor's Hand".
        *   **Стейкинг VC:** Пользователи блокируют VC (например, 1 млн на 90 дней).
        *   **Минт NFT "Investor's Hand\":** При стейкинге VC программа минтит (через Metaplex) NFT "Investor's Hand" соответствующего уровня.
        *   **Апгрейд NFT:** Реализует логику улучшения уровня NFT (сжигание старого, стейкинг дополнительных VC, минт нового).
        *   **Анстейкинг VC:** Возврат VC по истечении срока. NFT остается у пользователя.

    *   **Ж. Программа Стейкинга VG (`vg_staking_program`):**
        *   **Ответственность:** Стейкинг VG токенов для участия в DAO и получения наград.
        *   **Стейкинг VG:** Пользователи блокируют VG. Этот перевод VG на стейкинг-контракт проходит через стандартный механизм Token-2022 и, следовательно, облагается 10% налогом через программу-хук.
        *   **Использование NFT "Investor's Hand\":** При стейкинге VG можно применить NFT "Investor's Hand" для получения буста к наградам или других преимуществ.
        *   **Уровни DAO и Награды:** Реализует логику различных уровней участия в DAO и распределения наград стейкерам (с учетом автокомпаундинга для некоторых уровней). Анстейкинг также облагается налогом.

    *   **З. Программа Управления DAO (`governance_program`):**
        *   **Основа:** Интеграция с протоколом Realms.
        *   **Функционал:**
            *   Позволяет держателям застейканных VG токенов создавать предложения и голосовать по ним.
            *   Управляет параметрами других контрактов экосистемы (например, `TaxConfig` в `vg-token`, коэффициенты в "Burn and Earn") через специальную программу-исполнитель (DAO Executor), которая делает CPI-вызовы.
            *   Управляет казной DAO (куда поступает 50% от налога на VG).

**Взаимодействие и Потоки:**

*   **Получение VG:** VC + SOL → `burn_and_earn_program` (создание LP, блокировка) → Распределение VG с эскроу + Создание NFT Fee Key (через `nft_fee_key_program`).
*   **Налог на VG:** Любой перевод VG → Token-2022 вызывает `vg_transfer_hook_program` → Налог списывается и распределяется.
*   **Стейкинг и Бусты:** Стейкинг VC в `vc_staking_program` → NFT "Investor's Hand" → Применение NFT в `vg_staking_program` для улучшения условий.
*   **Управление:** Стейкинг VG в `vg_staking_program` → Участие в `governance_program` (Realms) → Изменение параметров экосистемы.

Эта система стремится к модульности, безопасности (через отзыв ненужных полномочий и использование стандартов) и прозрачности для пользователей (особенно с налогом через Transfer Hook). Ключевым моментом является корректная реализация и аудит программы-хука для VG токена и четкое управление полномочиями между всеми контрактами.
