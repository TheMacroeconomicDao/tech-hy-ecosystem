# Формула расчета VG токенов

## Обзор

Данный документ описывает формулу для расчета количества VG токенов, выдаваемых пользователю при блокировке LP токенов в механизме "Burn and Earn". Формула разработана таким образом, чтобы стимулировать пользователей блокировать большие объемы LP токенов.

## Базовая формула

Количество VG токенов, выдаваемых пользователю за блокировку LP токенов, рассчитывается по следующей формуле:

```
VG = LP * C * (1 + B * log10(LP/LP_min))
```

Где:
- `VG` - количество выдаваемых VG токенов
- `LP` - количество заблокированных LP токенов
- `C` - базовый коэффициент конверсии (10)
- `B` - бонусный коэффициент (0.2)
- `LP_min` - минимальное количество LP токенов для получения бонуса (1)

## Объяснение компонентов формулы

### Базовый коэффициент конверсии (C)

Базовый коэффициент конверсии определяет начальное соотношение между LP токенами и VG токенами. По умолчанию установлен равным 10, что означает, что за каждый заблокированный LP токен пользователь получает как минимум 10 VG токенов.

### Бонусный коэффициент (B)

Бонусный коэффициент определяет степень влияния размера блокировки на количество выдаваемых VG токенов. По умолчанию установлен равным 0.2, что обеспечивает умеренный бонус для крупных блокировок.

### Логарифмический множитель

Использование логарифма в формуле (`log10(LP/LP_min)`) обеспечивает нелинейное увеличение количества выдаваемых VG токенов при увеличении количества заблокированных LP токенов. Это стимулирует пользователей блокировать большие суммы, но при этом не создает чрезмерного преимущества для очень крупных блокировок.

Минимальное количество LP токенов для получения бонуса (`LP_min`) установлено равным 1, что означает, что бонус начинает действовать практически сразу.

## Реализация в коде

```rust
pub fn calculate_vg_amount(lp_amount: u64) -> Result<u64> {
    let base_conversion_rate: f64 = 10.0;
    let bonus_coefficient: f64 = 0.2;
    let min_lp_amount: f64 = 1.0;
    
    let lp_amount_f64 = lp_amount as f64;
    
    // Расчет бонуса на основе логарифма от количества LP токенов
    let bonus = 1.0 + bonus_coefficient * (lp_amount_f64 / min_lp_amount).log10().max(0.0);
    
    // Расчет итогового количества VG токенов
    let vg_amount = (lp_amount_f64 * base_conversion_rate * bonus).round() as u64;
    
    Ok(vg_amount)
}
```

## Примеры расчета

### Пример 1: Небольшая блокировка LP токенов

```
Входные данные:
- Количество LP токенов (LP): 10
- Базовый коэффициент конверсии (C): 10
- Бонусный коэффициент (B): 0.2
- Минимальное количество LP токенов (LP_min): 1

Расчет:
VG = 10 * 10 * (1 + 0.2 * log10(10/1))
VG = 10 * 10 * (1 + 0.2 * log10(10))
VG = 10 * 10 * (1 + 0.2 * 1)
VG = 10 * 10 * 1.2
VG = 120
```

### Пример 2: Средняя блокировка LP токенов

```
Входные данные:
- Количество LP токенов (LP): 1,000
- Базовый коэффициент конверсии (C): 10
- Бонусный коэффициент (B): 0.2
- Минимальное количество LP токенов (LP_min): 1

Расчет:
VG = 1,000 * 10 * (1 + 0.2 * log10(1,000/1))
VG = 1,000 * 10 * (1 + 0.2 * log10(1,000))
VG = 1,000 * 10 * (1 + 0.2 * 3)
VG = 1,000 * 10 * (1 + 0.6)
VG = 1,000 * 10 * 1.6
VG = 16,000
```

### Пример 3: Крупная блокировка LP токенов

```
Входные данные:
- Количество LP токенов (LP): 100,000
- Базовый коэффициент конверсии (C): 10
- Бонусный коэффициент (B): 0.2
- Минимальное количество LP токенов (LP_min): 1

Расчет:
VG = 100,000 * 10 * (1 + 0.2 * log10(100,000/1))
VG = 100,000 * 10 * (1 + 0.2 * log10(100,000))
VG = 100,000 * 10 * (1 + 0.2 * 5)
VG = 100,000 * 10 * (1 + 1)
VG = 100,000 * 10 * 2
VG = 2,000,000
```

## График зависимости

Для наглядного представления зависимости количества VG токенов от количества заблокированных LP токенов ниже приведен график:

```
      |
      |                                            *
  VG  |                                      *
токены|                                 *
      |                            *
      |                       *
      |                  *
      |             *
      |        *
      |    *
      |* *
      +-------------------------------------------
                     LP токены
```

## Управление параметрами формулы через DAO

Параметры формулы (базовый коэффициент конверсии и бонусный коэффициент) могут быть изменены через DAO. Это позволяет сообществу настраивать экономику токенов в зависимости от рыночных условий и целей развития экосистемы.

```rust
// Структура для хранения параметров формулы
#[account]
pub struct VgCalculationParameters {
    pub base_conversion_rate: u64,
    pub bonus_coefficient: u64,
    pub min_lp_amount: u64,
    pub authority: Pubkey,
    pub bump: u8,
}

// Функция для обновления параметров через DAO
pub fn update_vg_calculation_parameters(
    ctx: Context<UpdateVgCalculationParameters>,
    new_base_rate: Option<u64>,
    new_bonus_coefficient: Option<u64>,
    new_min_lp_amount: Option<u64>,
) -> Result<()> {
    // Проверка, что инструкция вызвана из предложения DAO
    require!(
        ctx.accounts.instruction_program.key() == spl_governance::ID,
        ErrorCode::NotAuthorized
    );
    
    let parameters = &mut ctx.accounts.vg_calculation_parameters;
    
    if let Some(base_rate) = new_base_rate {
        parameters.base_conversion_rate = base_rate;
    }
    
    if let Some(bonus_coefficient) = new_bonus_coefficient {
        parameters.bonus_coefficient = bonus_coefficient;
    }
    
    if let Some(min_lp_amount) = new_min_lp_amount {
        parameters.min_lp_amount = min_lp_amount;
    }
    
    Ok(())
}
```

## Соображения по безопасности и эффективности

1. **Обработка переполнения**:
   - При работе с большими числами необходимо обрабатывать возможное переполнение
   - Функция расчета должна возвращать ошибку при переполнении

2. **Округление**:
   - Округление результата до целого числа выполняется с помощью метода `round()`
   - Это обеспечивает справедливое распределение VG токенов

3. **Вычислительная эффективность**:
   - Логарифмическая операция требует вычислительных ресурсов
   - Необходимо оптимизировать код для минимизации использования вычислительных единиц (Compute Units)

4. **Предотвращение манипуляций**:
   - Параметры формулы должны быть защищены от несанкционированного изменения
   - Только DAO может менять эти параметры через голосование 