# Формула расчета периода стейкинга VG токенов

## Обзор

Данный документ описывает математическую модель и алгоритм расчета периода стейкинга для VG токенов в зависимости от количества токенов и наличия NFT-бустера.

## Базовая формула расчета

Период стейкинга (в днях) рассчитывается по следующей формуле:

```
P = Pbase * (1 - log(A/Amin) * K1) * (1 - B * K2)
```

Где:
- `P` - итоговый период стейкинга в днях
- `Pbase` - базовый период стейкинга (180 дней, 90 дней при автоматическом реинвестировании)
- `A` - количество стейкаемых VG токенов
- `Amin` - минимальное количество токенов для стейкинга (100 VG)
- `K1` - коэффициент влияния размера стейка (0.15)
- `B` - бустер-фактор от NFT (0 - без NFT, 1 - с NFT)
- `K2` - коэффициент влияния NFT-бустера (0.25)

## Объяснение компонентов формулы

### Базовый период стейкинга (Pbase)

Базовый период стейкинга определяет начальную продолжительность стейкинга до применения модификаторов. По умолчанию составляет 180 дней для обычного стейкинга и 90 дней при активации механизма автоматического реинвестирования (при стейкинге более 10,000 VG токенов).

### Влияние размера стейка

Компонент `(1 - log(A/Amin) * K1)` определяет, насколько сильно размер стейка влияет на период стейкинга. Чем больше количество стейкаемых токенов, тем меньше значение этого компонента, и, следовательно, тем короче период стейкинга.

- `A/Amin` - отношение количества стейкаемых токенов к минимальному количеству (100 VG)
- `log(A/Amin)` - логарифм этого отношения, что обеспечивает нелинейное сокращение периода
- `K1` - коэффициент, определяющий силу влияния размера стейка (0.15)

### Влияние NFT-бустера

Компонент `(1 - B * K2)` определяет влияние NFT-бустера на период стейкинга:

- `B` - бинарный флаг наличия NFT-бустера (0 - без NFT, 1 - с NFT)
- `K2` - коэффициент влияния NFT-бустера (0.25)

Если NFT-бустер применяется (B = 1), то период стейкинга умножается на 0.75, то есть сокращается на 25%.

## Ограничения периода стейкинга

Формула имеет следующие ограничения:

1. **Минимальный период стейкинга**: 30 дней
2. **Максимальный период стейкинга**: 180 дней

Если расчетный период стейкинга выходит за эти пределы, он ограничивается соответствующим значением.

## Автоматическое реинвестирование

При стейкинге более 10,000 VG токенов активируется механизм автоматического реинвестирования:

1. Базовый период стейкинга сокращается до 90 дней вместо 180 дней
2. По истечении периода стейкинга:
   - 70% токенов автоматически реинвестируются на новый период
   - 30% токенов доступны для вывода

Формальное условие активации автоматического реинвестирования:

```
is_auto_reinvestment = (A >= 10,000)
```

Расчет сумм для реинвестирования и вывода:

```
reinvest_amount = A * 0.7
withdraw_amount = A * 0.3
```

## Реализация в коде

```rust
pub fn calculate_staking_period(amount: u64, has_nft_booster: bool) -> u64 {
    let base_period: u64;
    let min_amount: u64 = 100;
    let k1: f64 = 0.15;
    let k2: f64 = 0.25;
    
    // Проверка на автоматическое реинвестирование
    if amount >= 10_000 {
        base_period = 90;
    } else {
        base_period = 180;
    }
    
    // Расчет влияния размера стейка
    let amount_factor = 1.0 - (amount as f64 / min_amount as f64).log10() * k1;
    
    // Расчет влияния NFT-бустера
    let booster_factor = if has_nft_booster { 1.0 - k2 } else { 1.0 };
    
    // Расчет итогового периода
    let period = (base_period as f64 * amount_factor * booster_factor).round() as u64;
    
    // Применение ограничений
    if period < 30 {
        return 30;
    } else if period > 180 {
        return 180;
    }
    
    period
}

pub fn is_auto_reinvestment(amount: u64) -> bool {
    amount >= 10_000
}

pub fn get_reinvestment_amounts(total_amount: u64) -> (u64, u64) {
    if !is_auto_reinvestment(total_amount) {
        return (0, total_amount);
    }
    
    let reinvest_amount = (total_amount as f64 * 0.7).round() as u64;
    let withdraw_amount = total_amount - reinvest_amount;
    
    (reinvest_amount, withdraw_amount)
}
```

## Примеры расчета

### Пример 1: Стейкинг без NFT-бустера

```
Входные данные:
- Количество VG: 1,000
- NFT-бустер: отсутствует

Расчет:
P = 180 * (1 - log(1000/100) * 0.15) * (1 - 0 * 0.25)
P = 180 * (1 - log(10) * 0.15) * 1
P = 180 * (1 - 1 * 0.15) * 1
P = 180 * 0.85 * 1
P = 153 дня
```

### Пример 2: Стейкинг с NFT-бустером

```
Входные данные:
- Количество VG: 5,000
- NFT-бустер: присутствует

Расчет:
P = 180 * (1 - log(5000/100) * 0.15) * (1 - 1 * 0.25)
P = 180 * (1 - log(50) * 0.15) * 0.75
P = 180 * (1 - 1.699 * 0.15) * 0.75
P = 180 * (1 - 0.255) * 0.75
P = 180 * 0.745 * 0.75
P = 100.6 дней ≈ 101 день
```

### Пример 3: Автоматическое реинвестирование

```
Входные данные:
- Количество VG: 15,000
- NFT-бустер: присутствует

Расчет:
P = 90 * (1 - log(15000/100) * 0.15) * (1 - 1 * 0.25)
P = 90 * (1 - log(150) * 0.15) * 0.75
P = 90 * (1 - 2.176 * 0.15) * 0.75
P = 90 * (1 - 0.326) * 0.75
P = 90 * 0.674 * 0.75
P = 45.5 дней ≈ 46 дней

Автоматическое реинвестирование:
- Реинвестируется: 10,500 VG (70%)
- Доступно для вывода: 4,500 VG (30%)
```

## График зависимости

Для наглядного представления зависимости периода стейкинга от количества токенов и наличия NFT-бустера ниже приведен график:

```
Период  180|  *
стейкинга  |     *
(дни)      |        *
           |           *
           |              *
           |                 *  - Без NFT-бустера
           |                    *
           |                       *
           |                          *
         90|                             *
           |                                *
           |                                   * - С NFT-бустером
           |                                      *
           |                                         *
           |                                            *
         30|--------------------------------------------------------
               100  1,000  5,000  10,000  50,000  100,000
                           Количество VG токенов
```

## Управление параметрами формулы через DAO

Параметры формулы могут быть изменены через DAO. Это позволяет сообществу настраивать условия стейкинга в зависимости от рыночных условий и целей развития экосистемы.

```rust
// Структура для хранения параметров формулы стейкинга
#[account]
pub struct StakingFormulaParameters {
    pub base_period_normal: u64,          // Базовый период для обычного стейкинга
    pub base_period_auto_reinvest: u64,   // Базовый период при автореинвестировании
    pub min_staking_amount: u64,          // Минимальное количество токенов
    pub size_influence_coefficient: u64,   // Коэффициент K1
    pub booster_influence_coefficient: u64, // Коэффициент K2
    pub auto_reinvestment_threshold: u64,  // Порог для автореинвестирования
    pub reinvestment_percentage: u8,       // Процент реинвестирования
    pub min_staking_period: u64,           // Минимальный период стейкинга
    pub max_staking_period: u64,           // Максимальный период стейкинга
    pub authority: Pubkey,
    pub bump: u8,
}

// Функция для обновления параметров через DAO
pub fn update_staking_formula_parameters(
    ctx: Context<UpdateStakingFormulaParameters>,
    new_parameters: StakingFormulaParametersArgs,
) -> Result<()> {
    // Проверка, что инструкция вызвана из предложения DAO
    require!(
        ctx.accounts.instruction_program.key() == spl_governance::ID,
        ErrorCode::NotAuthorized
    );
    
    let parameters = &mut ctx.accounts.staking_formula_parameters;
    
    // Обновление параметров
    if let Some(value) = new_parameters.base_period_normal {
        parameters.base_period_normal = value;
    }
    
    if let Some(value) = new_parameters.base_period_auto_reinvest {
        parameters.base_period_auto_reinvest = value;
    }
    
    // ... обновление остальных параметров ...
    
    Ok(())
}
```

## Соображения по безопасности и эффективности

1. **Вычислительная эффективность**:
   - Логарифмические операции требуют вычислительных ресурсов
   - Необходимо оптимизировать код для минимизации использования вычислительных единиц (Compute Units)

2. **Округление**:
   - Округление результата до целого числа выполняется с помощью метода `round()`
   - Это обеспечивает предсказуемый период стейкинга

3. **Предотвращение манипуляций**:
   - Параметры формулы должны быть защищены от несанкционированного изменения
   - Только DAO может менять эти параметры через голосование 