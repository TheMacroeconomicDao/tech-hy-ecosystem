# Механизм "Burn and Earn"

## Обзор механизма

Механизм "Burn and Earn" представляет собой процесс конвертации VC токенов в LP токены с последующей постоянной блокировкой (permanent lock) и получением VG токенов и NFT Fee Key. Этот механизм является ключевым элементом экосистемы VC/VG токенов, обеспечивающим ликвидность и стимулирующим долгосрочное участие пользователей.

## Процесс конвертации

### Шаги процесса

1. **Разделение VC токенов**:
   - Пользователь отправляет X количество VC токенов в смарт-контракт
   - Смарт-контракт разделяет X на две равные части: X/2 и X/2

2. **Обмен на SOL**:
   - Первая часть (X/2) VC токенов обменивается на SOL через Raydium AMM
   - Обмен происходит по текущему рыночному курсу
   - Полученное количество SOL = Y

3. **Формирование LP токена**:
   - Оставшаяся часть VC токенов (X/2) и полученные SOL (Y) используются для создания LP токена в пуле ликвидности Raydium
   - Количество полученных LP токенов = Z

4. **Постоянная блокировка LP токенов**:
   - LP токены (Z) переводятся на специальный аккаунт с постоянной блокировкой (permanent lock vault)
   - Из этого аккаунта невозможно вывести LP токены никогда

5. **Эмиссия VG токенов**:
   - Пользователю выдается количество VG токенов, пропорциональное заблокированным LP токенам
   - Количество VG = Z * коэффициент_конверсии + бонус

6. **Создание NFT Fee Key**:
   - Пользователю выдается NFT Fee Key, дающий право на получение части комиссий от транзакций с VG токенами

## Формула расчета VG токенов

Количество VG токенов, выдаваемых пользователю, рассчитывается по следующей формуле:

```
VG = LP * C * (1 + B * log10(LP/LP_min))
```

Где:
- `VG` - количество выдаваемых VG токенов
- `LP` - количество заблокированных LP токенов
- `C` - базовый коэффициент конверсии (10)
- `B` - бонусный коэффициент (0.2)
- `LP_min` - минимальное количество LP токенов для получения бонуса (1)

Эта формула обеспечивает нелинейное увеличение количества выдаваемых VG токенов при увеличении количества заблокированных LP токенов, стимулируя пользователей блокировать большие суммы.

## Постоянная блокировка LP токенов (Permanent Lock)

### Особенности постоянной блокировки

1. **Невозможность вывода**: LP токены, переведенные на аккаунт постоянной блокировки, не могут быть выведены никогда и никем, включая владельца программы.

2. **Прозрачность**: Все заблокированные LP токены видны в блокчейне и могут быть проверены любым пользователем.

3. **Учет вкладов**: Для каждого пользователя, заблокировавшего LP токены, сохраняется информация о количестве заблокированных токенов и времени блокировки.

### Реализация постоянной блокировки

Постоянная блокировка LP токенов реализуется через специальный аккаунт PermanentLockVault и аккаунты для отслеживания информации о блокировках пользователей (UserLockInfo).

Аккаунт PermanentLockVault создается как PDA (Program Derived Address) с известными seed-значениями и без возможности подписи транзакций на вывод токенов. Это обеспечивает невозможность вывода LP токенов из аккаунта.

## NFT Fee Key

При блокировке LP токенов пользователь получает NFT Fee Key, который дает право на получение части комиссий, собираемых с транзакций VG токенов.

### Характеристики NFT Fee Key

1. **Уровни NFT Fee Key**:

   | Уровень | Количество LP токенов | Множитель дохода |
   |---------|------------------------|-------------------|
   | Common  | < 1,000                | 1.0x              |
   | Rare    | 1,000 - 10,000         | 1.2x              |
   | Epic    | 10,000 - 100,000       | 1.5x              |
   | Legendary| > 100,000              | 2.0x              |

2. **Доля в пуле комиссий**:
   - Рассчитывается пропорционально заблокированным LP токенам с учетом множителя уровня
   - Формула: `share_percentage = (user_locked_lp * tier_multiplier) / total_weighted_locked_lp * 100%`

3. **Возможность передачи**:
   - NFT Fee Key может быть передан другому пользователю или продан на маркетплейсе
   - При передаче новый владелец получает право на сбор будущих комиссий

Подробная информация о NFT Fee Key представлена в документе [NFT Fee Key](./06-nft-fee-key.md).

## Интеграция с Raydium

### Использование Raydium SDK

Для интеграции с Raydium используется официальный Raydium SDK, который предоставляет функции для взаимодействия с пулами ликвидности и AMM. Основные функции включают:

- Обмен VC токенов на SOL через Raydium AMM с расчетом минимального выхода для защиты от проскальзывания цены
- Создание LP токенов путем добавления ликвидности в пул VC/SOL

### Атомарная транзакция

Для обеспечения безопасности и атомарности всего процесса конвертации VC в LP и последующей блокировки, все шаги выполняются в рамках одной транзакции. Это гарантирует, что либо весь процесс будет выполнен успешно, либо транзакция будет отменена без изменения состояния.

## Полная реализация механизма "Burn and Earn"

Полная реализация включает следующие ключевые этапы:
- Проверка баланса VC токенов пользователя
- Разделение VC токенов на две равные части
- Обмен первой половины на SOL через Raydium
- Добавление второй половины VC и полученного SOL в пул ликвидности
- Блокировка полученных LP токенов в специальном хранилище
- Расчет и минтинг VG токенов пользователю
- Создание NFT Fee Key для пользователя
- Обновление статистики механизма "Burn and Earn"

## Обработка ошибок и граничных случаев

### Недостаточная ликвидность

В случае недостаточной ликвидности в пуле Raydium для обмена VC на SOL, транзакция будет отменена с соответствующей ошибкой. Пользователю будет предложено уменьшить сумму конвертации или попробовать позже.

### Проскальзывание цены

Для защиты от проскальзывания цены при обмене VC на SOL используется параметр `minimum_amount_out`, который рассчитывается на основе текущего курса с учетом допустимого проскальзывания (например, 0.5%). Если фактическое проскальзывание превышает допустимое, транзакция отменяется.

### Ограничение размера транзакции

Для предотвращения манипуляций с ценой и обеспечения стабильности пула ликвидности, может быть введено ограничение на максимальный размер одной транзакции конвертации VC в LP.

## Интерфейс пользователя

Для удобства пользователей реализуется веб-интерфейс, который позволяет:

1. Просматривать текущий курс обмена VC на SOL
2. Рассчитывать ожидаемое количество VG токенов за указанное количество VC
3. Выполнять конвертацию VC в LP с последующей блокировкой и получением VG токенов и NFT Fee Key
4. Просматривать информацию о своих заблокированных LP токенах и полученных NFT Fee Key

## Экономическое обоснование

Механизм "Burn and Earn" создает экономическую ценность для участников экосистемы через:

1. **Увеличение ликвидности VC токенов**:
   - Создание и поддержание пула ликвидности VC/SOL
   - Стабилизация цены VC токенов

2. **Стимулирование долгосрочного участия**:
   - Постоянная блокировка LP токенов сокращает циркулирующее предложение
   - Получение VG токенов и NFT Fee Key создает долгосрочную заинтересованность

3. **Создание устойчивой экономики токенов**:
   - Налог на транзакции VG токенов создает постоянный доход для держателей NFT Fee Key
   - Часть налога используется для обратного выкупа и сжигания VC токенов, что создает дефляционный механизм

## Дальнейшие материалы

- [Архитектура системы](./01-system-architecture.md)
- [Токены экосистемы](./02-tokens.md)
- [NFT Fee Key](./06-nft-fee-key.md)
- [Формула расчета VG токенов](./specs/vg-calculation-formula.md) 